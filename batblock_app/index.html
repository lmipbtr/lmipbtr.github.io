<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Stlite App</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@stlite/browser@0.85.1/build/stlite.css"
    />
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@stlite/browser@0.85.1/build/stlite.js"
    ></script>
  </head>
  <body>
    <streamlit-app>
      import pandas as pd
      import streamlit as st

      agm_voltage_df = pd.DataFramedata = {
        "Voltage V": [12.6, 12.5, 12.42, 12.32, 12.2, 12.06, 11.9, 11.75, 11.58, 11.31, 10.5],
        "SoC %": [100, 90, 80, 70, 60, 50, 40, 30, 20, 10, 0]
      }
      
      lithium_voltage_df = pd.DataFramedata = {
        "Voltage V": [14.6, 13.5, 13.4, 13.3, 13.2, 13.1, 13.05, 13.0, 12.9, 12.8, 12, 10],
        "SoC %": [100, 99, 90, 80, 70, 60, 50, 40, 30, 20, 10, 0]
      }
      
      sla_voltage_df = pd.DataFramedata = {
        "Voltage V": [12.73, 12.62, 12.5, 12.37, 12.24, 12.1, 11.96, 11.81, 11.66, 11.51],
        "SoC %": [100, 90, 80, 70, 60, 50, 40, 30, 20, 10]
      }

      with st.container(border=True):
          st.write("Only press Submit if you change any of the default values")
          with st.form(key='Input_form', clear_on_submit = False):
              col1, col2 = st.columns(2)
              with col2:
                  batt_cap_unit = st.pills('Enter battery capacity units', options = ['Ah','Wh'],selection_mode="single",default = 'Ah')
              with col1:
                  batt_size = st.number_input(label='Enter battery capacity', value = 100.0, step = 1.0)
              batt_chem = st.pills(label='Enter battery chemistry', options = ['LiFePO4','AGM', 'SLA'], default = 'LiFePO4')
              batt_block_size = st.pills(label='Enter Batblock size', options = [25, 40], default = 25)
              batt_charge_current_max = st.number_input(label='Enter max Batblock charging current A', value = 25.0, step = 0.1)
              solar_panel_rated_current = st.number_input(label='Enter Solar Panel Rated Current', value = 20.0, step = 0.1)
              current_soc = st.slider("Enter State of Charge of battery", 0.0, 100.0, 50.0, step = 0.1)
              with col2:
                  load_unit = st.pills(label='Enter load unit', options = ['A', 'W'], default = 'A')
              with col1:
                  load = st.number_input(label='Enter load', value = 5.0, step = 0.1)
              submit_button = st.form_submit_button(label='Submit')
              
      title1 = "Outputs for " + str(batt_size) + " " + str(batt_cap_unit) + " "  + str(batt_chem) + " battery"  
      
      if batt_cap_unit == 'Ah':
          batt_size = batt_size
      elif batt_cap_unit == 'Wh' and batt_chem == 'LiFePO4':
          batt_size = batt_size / 12.8
      elif batt_cap_unit == 'Wh' and batt_chem == 'AGM' or batt_chem == 'SLA':
          batt_size = batt_size / 12.0
          
      if load_unit == 'A':
          load = load
      elif load_unit == 'W' and batt_chem == 'LiFePO4':
          load = load / 12.8
      elif load_unit == 'W' and batt_chem == 'AGM' or batt_chem == 'SLA':
          load = load / 12.0
          
      full_disch_time = (batt_size / load)
      full_charge_time_solar = (batt_size / solar_panel_rated_current)
      
      if batt_chem == 'LiFePO4':
          recc_batt_dod = 0.8
      elif batt_chem == 'AGM':
          recc_batt_dod = 0.5
      elif batt_chem == 'SLA':
          recc_batt_dod = 0.5
      part_discharge_time = full_disch_time * recc_batt_dod
      part_discharge_time2 = full_disch_time * ((current_soc / 100) - (1 - recc_batt_dod))
    
      with st.container(border=True):
          st.subheader(title1)
          
          st.subheader("Battery Discharge times", divider = True)
          col1, col2, col3 = st.columns([2,1,4])
          with col1:
              st.text("Full Discharge time:")
          with col2:
              st.text(str("{0:,.1f}".format(full_disch_time)))
          with col3:
              st.text("hours from 100% to 0%")
          with col1:
              st.text("Partial Discharge time:")
          with col2:
              st.text(str("{0:,.1f}".format(part_discharge_time)))
          with col3:
              st.text(" hours from 100% to recommended min SoC (" + str("{:,.0f}%".format(100 - ((recc_batt_dod) * 100)))+ ")")
          with col1:
              st.text("Partial Discharge time:")
          with col2:
              st.text(str("{0:,.2f}".format(part_discharge_time2)))
          with col3:
              if part_discharge_time2 >= 0:
                  st.text(" hours from " + str("{:,.1f}%".format(current_soc)) + " to recommended min SoC (" + str("{:,.0f}%".format((100 - (recc_batt_dod) * 100)))+ ")")
              else:
                  st.text("Battery SoC already below recommended minimum")
          with col1:
              st.text("Partial Discharge time:")
          with col2:
              st.text(str("{0:,.2f}".format(full_disch_time * (current_soc / 100))))
          with col3:
              st.text(" hours from " + str("{:,.1f}%".format(current_soc)) + " to 0%")
          
          st.subheader("Battery Charge times from solar panel", divider = True)
          col1, col2, col3 = st.columns([3,1,4])
          with col1:
              st.text("Charge Time from empty to full:")
          with col2:
              st.text(str("{0:,.1f}".format(full_charge_time_solar)))
          with col3:
              st.text("hours of full sunlight")
          with col1:
              st.text("Charge Time from " + str("{:,.0f}%".format((1 - recc_batt_dod) * 100)) + " SoC to full:")
          with col2:
              st.text(str("{0:,.1f}".format(full_charge_time_solar * recc_batt_dod)))
          with col3:
              st.text(" hours of full sunlight")
          with col1:
              st.text("Charge Time from " + str("{:,.1f}%".format(current_soc)) + " SoC to full:")
          with col2:
              st.text(str("{0:,.2f}".format(full_charge_time_solar * ((100 - current_soc ) / 100))))
          with col3:
              st.text(" hours of full sunlight")
          
          st.subheader("Battery Charge times from alternator", divider = True)
          col1, col2, col3 = st.columns([3,1,4])
          with col1:
              st.text("Charge Time from empty to full:")
          with col2:
              st.text(str("{0:,.1f}".format(batt_size / batt_charge_current_max)))
          with col3:
              st.text("hours of driving")
          with col1:
              st.text("Charge Time from " + str("{:,.0f}%".format((1 - recc_batt_dod) * 100)) + " SoC to full:")
          with col2:
              st.text(str("{0:,.1f}".format(batt_size * (recc_batt_dod/ batt_charge_current_max))))
          with col3:
              st.text(" hours of driving")
          with col1:
              st.text("Charge Time from " + str("{:,.1f}%".format(current_soc)) + " SoC to full:")
          with col2:
              st.text(str("{0:,.2f}".format(((batt_size / batt_charge_current_max) * ((100 - current_soc) / 100)))))
          with col3:
              st.text(" hours of driving")
                  
      with st.container(border=True):
          if batt_chem == "LiFePO4":
              st.subheader("LiFePO4 Battery Voltage/SoC characteristics", divider = True)
              st.dataframe(lithium_voltage_df, use_container_width=False, width = 150)
          elif batt_chem == "AGM":
              st.subheader("AGM Battery Voltage/SoC characteristics", divider = True)
              st.dataframe(agm_voltage_df, use_container_width=False, width = 150)
          elif batt_chem == "SLA":
              st.subheader("SLA Battery Voltage/SoC characteristics", divider = True)
              st.dataframe(sla_voltage_df, use_container_width=False, width = 150)

    </streamlit-app>
  </body>
</html>
